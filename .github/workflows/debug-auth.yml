name: DEBUG AUTH

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  debug-auth:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print SERVICE_ACCOUNT secret
        run: echo "SERVICE_ACCOUNT=${{ secrets.SERVICE_ACCOUNT }}"

      - name: Print SERVICE_ACCOUNT length
        run: echo "Length: ${{ secrets.SERVICE_ACCOUNT | length }}"

      - name: Print WIF_PROVIDER secret
        run: echo "WIF_PROVIDER=${{ secrets.WIF_PROVIDER }}"

      - name: Try auth (DO NOT FAIL)
        id: auth
        continue-on-error: true
        uses: google-github-actions/auth@v1
        with:
          token_format: "access_token"
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true
          cleanup_credentials: false

      - name: Print auth step result
        run: |
          echo "Auth outcome: ${{ steps.auth.outcome }}"
          echo "Auth conclusion: ${{ steps.auth.conclusion }}"

      - name: Print environment variables after auth
        run: |
          echo "CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=$CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"
          echo "GOOGLE_GHA_CREDS_PATH=$GOOGLE_GHA_CREDS_PATH"

      - name: Print gcloud auth list
        run: gcloud auth list || true

      - name: Print credentials file
        run: |
          echo "Listing creds file:"
          ls -la $GOOGLE_APPLICATION_CREDENTIALS || true
          echo "Contents:"
          cat $GOOGLE_APPLICATION_CREDENTIALS || true
